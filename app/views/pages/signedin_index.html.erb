<% cuid = current_user.id %>
<div class="center">

	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	    
	<article>
		<p id="loading">Finding your location: <span id="status">checking...</span></p>
	</article>
	<script>
		function success(position) {
			var s = document.querySelector('#status');

			if (s.className == 'success') {
		    	// not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back    
		    	return;
			}

			s.innerHTML = "found you!";
			s.className = 'success';

			var mapcanvas = document.createElement('div');
			mapcanvas.id = 'mapcanvas';
			mapcanvas.style.height = ($(document).height() - 51) + 'px';
			mapcanvas.style.width = ($(document).width()) + 'px';

			$("#loading").css("display","none");

			

			document.querySelector('article').appendChild(mapcanvas);

			var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
			var latlngTest = new google.maps.LatLng(position.coords.latitude, position.coords.longitude + 0.00005);

			var myOptions = {
				zoom: 20,
				center: latlng,
				zoomControl: false,
				streetViewControl: false,
				navigationControlOptions: {style: google.maps.NavigationControlStyle.DEFAULT},
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				mapTypeControl: true,
    			mapTypeControlOptions: {
      			style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
    			}
			};
			map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);

			//// ******** BUTTON

			// Create a div to hold the control.
			var controlDiv = document.createElement('div');

			// Set CSS styles for the DIV containing the control
			// Setting padding to 5 px will offset the control
			// from the edge of the map.
			controlDiv.style.padding = '5px';

			// Set CSS for the control border.
			var controlUI = document.createElement('div');
			controlUI.style.backgroundColor = 'white';
			controlUI.style.cursor = 'pointer';
			controlUI.style.textAlign = 'center';
			controlUI.title = 'Click to refresh map';
			controlDiv.appendChild(controlUI);

			// Set CSS for the control interior.
			var controlText = document.createElement('div');
			controlText.style.fontFamily = 'Arial,sans-serif';
			controlText.style.fontSize = '12px';
			controlText.style.paddingLeft = '4px';
			controlText.style.paddingRight = '4px';
			controlText.innerHTML = '<strong>Refresh</strong>';
			controlUI.appendChild(controlText);

			google.maps.event.addDomListener(controlUI, 'click', function() {
		   		map.setCenter(new google.maps.LatLng(42.369591, -71.255408));
  			});

			controlDiv.index = 1;
  			map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlDiv);

			//// ******** BUTTON

//******HERE STARTS MAPPING OF BRANDEIS, THIS WILL BE MOVED**************//
			var opac = 0.35;

			var SSCCoords = [
		  		new google.maps.LatLng(42.366061, -71.258425),
		        new google.maps.LatLng(42.365953, -71.258642),
				new google.maps.LatLng(42.365742, -71.258564),
			    new google.maps.LatLng(42.365875, -71.257893),
			    new google.maps.LatLng(42.366034, -71.257706),
			    new google.maps.LatLng(42.366145, -71.257910)
			];

		  	
		  	SSC = new google.maps.Polygon({
		    paths: SSCCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

			var libraryCoords = [
				new google.maps.LatLng(42.367700, -71.258654),
				new google.maps.LatLng(42.367796, -71.257983),
				new google.maps.LatLng(42.368675, -71.257629),
				new google.maps.LatLng(42.368790, -71.258208),
				new google.maps.LatLng(42.367906, -71.258835)
			];

		  	// Construct the library
		  	library = new google.maps.Polygon({
		    paths: libraryCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

		  //	google.maps.geometry.poly.containsLocation(google.maps.LatLng(latitude, longitude),polygons);

		  	var usdanCoords = [
		  		new google.maps.LatLng(42.367953, -71.257469),
		  		new google.maps.LatLng(42.367774, -71.256417),
		  		new google.maps.LatLng(42.368218, -71.256224),
		  		new google.maps.LatLng(42.368424, -71.257276)
		  	];

		  	usdan = new google.maps.Polygon({
		    paths: usdanCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

		  	//***HERE STARTS MASSELL QUAD****

		  	var usenCoords = [
		  		new google.maps.LatLng(42.366991, -71.260724),
		  		new google.maps.LatLng(42.366979, -71.260547),
		  		new google.maps.LatLng(42.367347, -71.260504),
		  		new google.maps.LatLng(42.367351, -71.260681)
		  	];
		  	

		  	usen = new google.maps.Polygon({
		    paths: usenCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

		  	var renCoords = [
		  		new google.maps.LatLng(42.367480, -71.261287),
		  		new google.maps.LatLng(42.367365, -71.260839),
		  		new google.maps.LatLng(42.367478, -71.260778),
		  		new google.maps.LatLng(42.367599, -71.261234)
		  	];
		  	

		  	ren = new google.maps.Polygon({
		    paths: renCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});


		  	var deroyCoords = [
		  		new google.maps.LatLng(42.367218, -71.261663),
		  		new google.maps.LatLng(42.367458, -71.261411),
		  		new google.maps.LatLng(42.367532, -71.261542),
		  		new google.maps.LatLng(42.367298, -71.261783)		
		  	];
		  	

		  	deroy = new google.maps.Polygon({
		    paths: deroyCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

		  	var shapiroCoords = [
		  		new google.maps.LatLng(42.366378, -71.261164),
		  		new google.maps.LatLng(42.366455, -71.260998),
		  		new google.maps.LatLng(42.367156, -71.261444),
		  		new google.maps.LatLng(42.367063, -71.261669)		
		  	];
		  	

		  	shapiro = new google.maps.Polygon({
		    paths: shapiroCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

		  

		  	//***HERE ENDS MASSELL QUAD

		  	//***HERE BEGINS ROSENTHAL QAUD
		  	var rosNorthCoords = [
		  		new google.maps.LatLng(42.367217, -71.260349),
		  		new google.maps.LatLng(42.367217, -71.259953),
		  		new google.maps.LatLng(42.367416, -71.259950),
		  		new google.maps.LatLng(42.367427, -71.260323)		
		  	];
		  	

		  	rosNorth = new google.maps.Polygon({
		    paths: rosNorthCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

		  	var rosEastCoords = [
		  		new google.maps.LatLng(42.366917, -71.260045),
		  		new google.maps.LatLng(42.366911, -71.259771),
		  		new google.maps.LatLng(42.367216, -71.259771),
		  		new google.maps.LatLng(42.367224, -71.260045)		
		  	];
		  	

		  	rosEast = new google.maps.Polygon({
		    paths: rosEastCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});


		  	var rosSouthCoords = [
		  		new google.maps.LatLng(42.366755, -71.260401),
		  		new google.maps.LatLng(42.366741, -71.259959),
		  		new google.maps.LatLng(42.366949, -71.259953),
		  		new google.maps.LatLng(42.366963, -71.260372)		
		  	];
		  	

		  	rosSouth = new google.maps.Polygon({
		    paths: rosSouthCoords,
		    strokeColor: '#FF0000',
		    strokeOpacity: 0.8,
		    strokeWeight: 2,
		    fillColor: '#00AAAA',
		    fillOpacity: opac
		  	});

		  	//***HERE ENDS ROSENTHAL QUAD
		  	
		  	
		  	SSC.setMap(map);
		  	library.setMap(map);
		  	usdan.setMap(map);
		  	usen.setMap(map);
		  	ren.setMap(map);
		  	deroy.setMap(map);
		  	shapiro.setMap(map);
		  	rosNorth.setMap(map);
		  	rosEast.setMap(map);
		  	rosSouth.setMap(map);


//*********HERE ENDS MAPPING OF BRANDEIS******************//

			var mymarker = new google.maps.Marker({
				position: latlng, 
				map: map, 
				title:"You are here! (at least within a "+position.coords.accuracy+" meter radius)",
				zIndex: 2
			});
			
			var myinfowindow = new google.maps.InfoWindow({
				content: "You are here!"
			});

			google.maps.event.addListener(mymarker, 'click', function() {
				myinfowindow.open(map, mymarker);
			});

			$.getJSON( "get_markers/getmark.json", function( data ) {
				console.log("in ajax");
				console.log(data);
			  for( i = 0; i < data.length; i++) {
	            var newlatLng = new google.maps.LatLng(data[i][1].lat, data[i][2].lng);
	            var newmarker = new google.maps.Marker({
	                position: latLng,
	                map: map
	            });
	            var newmyinfowindow = new google.maps.InfoWindow({
					content: data[i][0]
				});
				google.maps.event.addListener(mymarker, 'click', function() {
					myinfowindow.open(map, newmymarker);
				});
	          }
			});


	

			$.ajax({  
			    type: 'POST',  
			    url: '/check_in', 
			    data: { latitude: latlng.lat(), longitude: latlng.lng() },
			    success: function(response) {
			        
			    }
			});

			setInterval(function() {
			    $.ajax({  
			    type: 'POST',  
			    url: '/check_in', 
			    data: { latitude: latlng.lat(), longitude: latlng.lng() },
			    success: function(response) {
			        
			    }
			});
			}, 10 * 60 * 1000); // 10 * 60 * 1000 milsec
		}



		function error(msg) {
			var s = document.querySelector('#status');
			s.innerHTML = typeof msg == 'string' ? msg : "failed";
			s.className = 'fail';
		}

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(success, error);
		} else {
			error('not supported');
		}

	</script>
</div>