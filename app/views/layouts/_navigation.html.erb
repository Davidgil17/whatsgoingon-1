<%# navigation styled for Bootstrap 3.0 %>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="navbar navbar-default navbar-fixed-top nounderline">
    <div class="container">
      <div class="navbar-header">
        <%= link_to "What's Going On?", root_path, class: 'navbar-brand' %>
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
      </button>
  </div>
  <div class="navbar-collapse collapse nounderline" id="navbar-main">
    <ul class="nav navbar-nav">
        <% if user_signed_in? %>
        <li><%= link_to "Friends", "#myModal", "data-toggle" => "modal" %></li>
        <li><%= link_to "Groups", groups_path %></li>
        <li><%= link_to 'My Account', current_user %></li>
        <% else %>
        <% end %>
    </ul>

    <ul class="nav navbar-nav navbar-right nounderline">
      <% if user_signed_in? %>
      <!-- <li><%= link_to current_user.name, current_user %></li> -->
      <li><%= link_to "Logout", destroy_user_session_path %></li>
      <% else %>
      <li><%= link_to "Sign in", new_user_session_path %></li>
      <% end %>
  </ul>

</div>
</div>
</div>
<% if current_user.nil? %>
  <% else %>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Friends Near You</h4>
          </div>
          <div class="modal-body">

            <% cuid = current_user.id %>
            <script>
            function roundToTwo(num) {    
              return +(Math.round(num + "e+2")  + "e-2");
            }
            function success(position) {
              

              document.querySelector("#therowsinthebody").innerHTML = '<% for i in 0...CheckIn.most_recent(cuid).length %><%= link_to (raw "<div class=\"row card\"><div class=\"col-md-12 listrow\">" + User.find(CheckIn.most_recent(cuid)[i][:user_id])[:name].to_s + "<span class=\"right\">"+CheckIn.most_recent(cuid)[i][:location].to_s+"&nbsp;&nbsp;&nbsp;"+"\'+getDistanceFromLatLonInMi(" + CheckIn.most_recent(cuid)[i][:latitude].to_s + ", " + CheckIn.most_recent(cuid)[i][:longitude].to_s + ", position.coords.latitude, position.coords.longitude)+\'</span></div></div>"), ("/?lat="+CheckIn.most_recent(cuid)[i][:latitude].to_s+"&lng="+CheckIn.most_recent(cuid)[i][:longitude].to_s) %><% end %><% if CheckIn.most_recent(cuid).length == 0 %><%= raw "<div class=\"card\">No recent friends</div>" %><% end %>';
            }

            function getDistanceFromLatLonInMi(lat1,lon1,lat2,lon2) {
              var R = 6371; // Radius of the earth in km
              var dLat = deg2rad(lat2-lat1);  // deg2rad below
              var dLon = deg2rad(lon2-lon1); 
              var a = 
              Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
              Math.sin(dLon/2) * Math.sin(dLon/2)
              ; 
              var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
              var d = R * c; // Distance in km
              var dInMi = d*0.621371; // American units
              return (dInMi < 0.1 ? "<0.1 mi" : roundToTwo(dInMi).toString() + " mi"); 
            }

            function deg2rad(deg) {
              return deg * (Math.PI/180)
            }

            function error(msg) {
              var s = document.querySelector('#status');
              s.innerHTML = typeof msg == 'string' ? msg : "failed";
              s.className = 'fail';
            }

            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(success, error);
            } else {
              error('not supported');
            }
            </script>
            <div id="therowsinthebody">
            </div>

            <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=geometry&sensor=false"></script>
           
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<% end %>