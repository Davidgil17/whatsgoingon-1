<div class="center">

	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<article>
		<p id="loading">Finding your location: <span id="status">checking...</span></p>
	</article>

	<script>
		function success(position) {
			var s = document.querySelector('#status');

			if (s.className == 'success') {
		    	// not sure why we're hitting this twice in FF, I think it's to do with a cached result coming back    
		    	return;
			}

			s.innerHTML = "found you!";
			s.className = 'success';

			var mapcanvas = document.createElement('div');
			mapcanvas.id = 'mapcanvas';
			mapcanvas.style.height = ($(document).height() - 80) + 'px';
			mapcanvas.style.width = ($(document).width() - 30) + 'px';

			$("#loading").css("display","none");

			document.querySelector('article').appendChild(mapcanvas);

			var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
			var latlngTest = new google.maps.LatLng(position.coords.latitude, position.coords.longitude + 0.00005);

			var myOptions = {
				zoom: 20,
				center: latlng,
				mapTypeControl: false,
				navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			var map = new google.maps.Map(document.getElementById("mapcanvas"), myOptions);

			// var mymarker = new google.maps.Marker({
			// 	position: latlng, 
			// 	map: map, 
			// 	title:"You are here! (at least within a "+position.coords.accuracy+" meter radius)"
			// });
			
			// var myinfowindow = new google.maps.InfoWindow({
			// 	content: "Hi"
			// });

			// google.maps.event.addListener(mymarker, 'click', function() {
			// 	myinfowindow.open(map, mymarker);
			// });

			<% for i in 1...CheckIn.most_recent.length %>
			<%=	"var newlatlng"+i.to_s+" = new google.maps.LatLng(" + CheckIn.most_recent[i][:latitude].to_s + ", " + CheckIn.most_recent[i][:longitude].to_s + ");" %>
			<%= "var newmarker"+i.to_s+" = new google.maps.Marker({position: newlatlng"+i.to_s+", map: map, title: " + CheckIn.most_recent[i][:user_id].to_s + "});" %>
			<% end %>

			$.ajax({  
			    type: 'POST',  
			    url: '/check_in', 
			    data: { latitude: latlng.lat(), longitude: latlng.lng() },
			    success: function(response) {
			        
			    }
			});
		}



		function error(msg) {
			var s = document.querySelector('#status');
			s.innerHTML = typeof msg == 'string' ? msg : "failed";
			s.className = 'fail';
		}

		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(success, error);
		} else {
			error('not supported');
		}

	</script>
</div>